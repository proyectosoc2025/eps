╔════════════════════════════════════════════════════════════════════════════╗
║                    HOSPITAL EPS - DIAGRAMA DE FLUJO                        ║
╚════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────┐
│                         FLUJO DE AUTENTICACIÓN                          │
└─────────────────────────────────────────────────────────────────────────┘

    ┌──────────────┐
    │  index.php   │  ◄── Usuario accede al sistema
    │   (Login)    │
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │ Ingresa      │
    │ Usuario y    │
    │ Contraseña   │
    └──────┬───────┘
           │
           ▼
    ┌──────────────────────┐
    │ security.php         │
    │ Detecta Inyección    │ ──► SI ──► Bloquea y registra en logs
    │ SQL?                 │
    └──────┬───────────────┘
           │ NO
           ▼
    ┌──────────────────────┐
    │ api/login.php        │
    │ Valida credenciales  │
    └──────┬───────────────┘
           │
           ├──► Busca en tabla: administradores
           ├──► Busca en tabla: doctores
           └──► Busca en tabla: pacientes
           │
           ▼
    ┌──────────────────────┐
    │ ¿Credenciales        │
    │ correctas?           │
    └──────┬───────────────┘
           │
           ├──► NO ──► Mensaje de error
           │
           └──► SI
                │
                ▼
         ┌──────────────┐
         │ Crea sesión  │
         │ Registra log │
         └──────┬───────┘
                │
                ▼
         ┌──────────────────────────────────┐
         │     Redirige según ROL           │
         └──────┬───────────────────────────┘
                │
    ┌───────────┼───────────┐
    │           │           │
    ▼           ▼           ▼
┌────────┐  ┌────────┐  ┌──────────┐
│ Admin  │  │ Doctor │  │ Paciente │
│ Panel  │  │ Panel  │  │  Panel   │
└────────┘  └────────┘  └──────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                      FLUJO DEL ADMINISTRADOR                            │
└─────────────────────────────────────────────────────────────────────────┘

    ┌──────────────────┐
    │  Dashboard       │
    │  Administrador   │
    └────────┬─────────┘
             │
    ┌────────┴────────────────────────────────────┐
    │                                             │
    ▼                                             ▼
┌─────────────────┐                    ┌──────────────────┐
│ Gestión         │                    │ Gestión          │
│ Pacientes       │                    │ Doctores         │
│                 │                    │                  │
│ • Crear         │                    │ • Crear          │
│ • Modificar     │                    │ • Modificar      │
│ • Eliminar      │                    │ • Eliminar       │
│ • Ver todos     │                    │ • Ver todos      │
└─────────────────┘                    └──────────────────┘
    │                                             │
    ▼                                             ▼
┌─────────────────┐                    ┌──────────────────┐
│ Gestión         │                    │ Historias        │
│ Administradores │                    │ Clínicas         │
│                 │                    │                  │
│ • Crear nuevos  │                    │ • Ver todas      │
│ • Eliminar      │                    │ • Crear nuevas   │
│ • Ver todos     │                    │ • Eliminar       │
└─────────────────┘                    └──────────────────┘
    │                                             │
    ▼                                             ▼
┌─────────────────────────────────────────────────────────┐
│                    Logs del Sistema                     │
│                                                         │
│  • Ver todos los movimientos                           │
│  • Filtrar por usuario                                 │
│  • Filtrar por acción                                  │
│  • Ver intentos de inyección SQL                       │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                        FLUJO DEL DOCTOR                                 │
└─────────────────────────────────────────────────────────────────────────┘

    ┌──────────────────┐
    │  Dashboard       │
    │  Doctor          │
    └────────┬─────────┘
             │
    ┌────────┴────────────────────────┐
    │                                 │
    ▼                                 ▼
┌─────────────────┐        ┌──────────────────┐
│ Mi Perfil       │        │ Mis Pacientes    │
│                 │        │                  │
│ • Ver datos     │        │ • Ver solo mis   │
│ • Modificar     │        │   pacientes      │
│ • Actualizar    │        │ • Registrar      │
│   información   │        │   nuevos         │
└─────────────────┘        └──────────────────┘
                                    │
                                    ▼
                          ┌──────────────────┐
                          │ Historias        │
                          │ Clínicas         │
                          │                  │
                          │ • Crear nuevas   │
                          │ • Ver mis        │
                          │   historias      │
                          │ • Modificar      │
                          │ • Eliminar       │
                          └──────────────────┘
                                    │
                                    ▼
                          ┌──────────────────┐
                          │ Registro         │
                          │ automático en:   │
                          │                  │
                          │ • historias_     │
                          │   clinicas       │
                          │ • visitas_       │
                          │   medicas        │
                          │ • logs           │
                          └──────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                       FLUJO DEL PACIENTE                                │
└─────────────────────────────────────────────────────────────────────────┘

    ┌──────────────────┐
    │  Dashboard       │
    │  Paciente        │
    └────────┬─────────┘
             │
    ┌────────┴────────────────────────┐
    │                                 │
    ▼                                 ▼
┌─────────────────┐        ┌──────────────────┐
│ Mi Perfil       │        │ Mis Historias    │
│                 │        │ Clínicas         │
│ • Ver datos     │        │                  │
│ • Modificar:    │        │ • Ver todas mis  │
│   - Contraseña  │        │   historias      │
│   - Dirección   │        │ • Ver doctor     │
│   - Correo      │        │ • Ver           │
│   - Teléfono    │        │   diagnósticos   │
│                 │        │ • Ver           │
│ • NO puede      │        │   medicamentos   │
│   modificar     │        │ • Ver           │
│   otros datos   │        │   tratamientos   │
└─────────────────┘        └──────────────────┘
                                    │
                                    ▼
                          ┌──────────────────┐
                          │ Mis Visitas      │
                          │ Médicas          │
                          │                  │
                          │ • Ver historial  │
                          │ • Ver fechas     │
                          │ • Ver doctores   │
                          │   que atendieron │
                          │ • Ver motivos    │
                          └──────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                    FLUJO DE SEGURIDAD                                   │
└─────────────────────────────────────────────────────────────────────────┘

    ┌──────────────────┐
    │ Usuario ingresa  │
    │ datos            │
    └────────┬─────────┘
             │
             ▼
    ┌──────────────────────┐
    │ security.php         │
    │ detectSQLInjection() │
    └────────┬─────────────┘
             │
    ┌────────┴────────┐
    │                 │
    ▼                 ▼
┌─────────┐    ┌──────────────┐
│ Patrón  │    │ Patrón       │
│ SQL     │    │ seguro       │
│ detectado│   │              │
└────┬────┘    └──────┬───────┘
     │                │
     ▼                ▼
┌─────────────┐  ┌──────────────┐
│ Bloquear    │  │ Continuar    │
│ acceso      │  │ proceso      │
└─────┬───────┘  └──────┬───────┘
      │                 │
      ▼                 ▼
┌─────────────┐  ┌──────────────┐
│ Registrar   │  │ Sanitizar    │
│ en logs:    │  │ input        │
│             │  └──────┬───────┘
│ • Usuario   │         │
│ • IP        │         ▼
│ • Fecha     │  ┌──────────────┐
│ • Intento   │  │ Ejecutar     │
└─────────────┘  │ operación    │
                 └──────┬───────┘
                        │
                        ▼
                 ┌──────────────┐
                 │ Registrar    │
                 │ en logs      │
                 └──────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                  RELACIONES DE BASE DE DATOS                            │
└─────────────────────────────────────────────────────────────────────────┘

    ┌──────────────────┐
    │  administradores │
    └────────┬─────────┘
             │
             │ admin_id
             │
             ▼
    ┌──────────────────┐         ┌──────────────────┐
    │    doctores      │         │    pacientes     │
    └────────┬─────────┘         └────────┬─────────┘
             │                            │
             │ doctor_id                  │ paciente_id
             │                            │
             └────────┬───────────────────┘
                      │
                      ▼
             ┌──────────────────┐
             │ historias_       │
             │ clinicas         │
             └────────┬─────────┘
                      │
                      │ historia_clinica_id
                      │
                      ▼
             ┌──────────────────┐
             │ visitas_         │
             │ medicas          │
             └──────────────────┘

    ┌──────────────────┐
    │      logs        │  ◄── Registra todas las acciones
    │                  │      de todos los usuarios
    └──────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                    FLUJO DE DATOS                                       │
└─────────────────────────────────────────────────────────────────────────┘

Usuario → Frontend (HTML/CSS/JS/Bootstrap)
            ↓
         Validación JavaScript
            ↓
         API PHP (api/*.php)
            ↓
         Seguridad (security.php)
            ↓
         Base de Datos (MySQL)
            ↓
         Logs (tabla logs)
            ↓
         Respuesta JSON
            ↓
         Actualización UI

╔════════════════════════════════════════════════════════════════════════════╗
║                         FIN DEL DIAGRAMA                                   ║
╚════════════════════════════════════════════════════════════════════════════╝
